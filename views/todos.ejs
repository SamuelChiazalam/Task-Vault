<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Todos - Todo App</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <header class="app-header">
      <div class="header-content">
        <h1>My Todos</h1>
        <div class="user-info">
          <span>Welcome, <strong><%= username %></strong>!</span>
          <a href="/auth/logout" class="btn btn-secondary">Logout</a>
        </div>
      </div>
    </header>

    <div class="filter-bar">
      <a href="/todos?filter=all" class="filter-btn <%= filter === 'all' ? 'active' : '' %>">All</a>
      <a href="/todos?filter=pending" class="filter-btn <%= filter === 'pending' ? 'active' : '' %>">Pending</a>
      <a href="/todos?filter=completed" class="filter-btn <%= filter === 'completed' ? 'active' : '' %>">Completed</a>
    </div>

    <div class="add-todo-section">
      <h2>Add New Todo</h2>
      <form action="/todos/create" method="POST" class="todo-form">
        <div class="form-group">
          <input type="text" name="title" placeholder="Todo title" required>
        </div>
        <div class="form-group">
          <textarea name="description" placeholder="Description (optional)" rows="2"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Add Todo</button>
      </form>
    </div>

    <div class="todos-list">
      <% if (todos.length === 0) { %>
        <div class="empty-state">
          <p>No todos found. Create one to get started!</p>
        </div>
      <% } else { %>
        <% todos.forEach(todo => { %>
          <div class="todo-item <%= todo.status %>" data-id="<%= todo._id %>">
            <div class="todo-content">
              <h3 class="todo-title"><%= todo.title %></h3>
              <% if (todo.description) { %>
                <p class="todo-description"><%= todo.description %></p>
              <% } %>
              <span class="todo-date">Created: <%= new Date(todo.createdAt).toLocaleDateString() %></span>
            </div>
            <div class="todo-actions">
              <% if (todo.status === 'pending') { %>
                <button onclick="updateStatus('<%= todo._id %>', 'completed')" class="btn btn-success">Complete</button>
              <% } else if (todo.status === 'completed') { %>
                <button onclick="updateStatus('<%= todo._id %>', 'pending')" class="btn btn-warning">Reopen</button>
              <% } %>
              <button onclick="deleteTodo('<%= todo._id %>')" class="btn btn-danger">Delete</button>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>

  <script>
    async function updateStatus(id, status) {
      try {
        const response = await fetch(`/todos/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        
        if (response.ok) {
          location.reload();
        } else {
          alert('Error updating todo');
        }
      } catch (error) {
        alert('Error updating todo');
      }
    }

    async function deleteTodo(id) {
      if (!confirm('Are you sure you want to delete this todo?')) return;
      
      try {
        const response = await fetch(`/todos/${id}/delete`, {
          method: 'POST'
        });
        
        if (response.ok) {
          location.reload();
        } else {
          alert('Error deleting todo');
        }
      } catch (error) {
        alert('Error deleting todo');
      }
    }
  </script>
</body>
</html>